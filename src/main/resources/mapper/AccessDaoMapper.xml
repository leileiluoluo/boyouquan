<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.boyouquan.dao.AccessDaoMapper">
    <sql id="insert_columns">
        link,
        blog_domain_name,
        ip,
        from,
        accessed_at
    </sql>
    <select id="countAll" resultType="java.lang.Long">
        SELECT
        COUNT(*)
        FROM access
    </select>
    <select id="getMostAccessedBlogDomainNameInLatestOneMonth" resultType="com.boyouquan.model.BlogDomainNameAccess">
        SELECT
        blog_domain_name as blogDomainName,
        COUNT(*) as accessCount
        FROM access
        WHERE date(accessed_at) >= DATE_SUB(CURDATE(), INTERVAL 1 MONTH)
        GROUP BY blog_domain_name
        ORDER BY accessCount DESC LIMIT 1
    </select>
    <select id="getBlogAccessSeriesInLatestOneYear" resultType="com.boyouquan.model.MonthAccess">
        SET sql_mode ='STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_ENGINE_SUBSTITUTION';

        select v.month,ifnull(b.count,0)  count from (
        SELECT DATE_FORMAT((CURDATE() - INTERVAL 11 MONTH), '%Y/%m') AS `month`
        UNION SELECT DATE_FORMAT((CURDATE() - INTERVAL 10 MONTH), '%Y/%m') AS `month`
        UNION SELECT DATE_FORMAT((CURDATE() - INTERVAL 9 MONTH), '%Y/%m') AS `month`
        UNION SELECT DATE_FORMAT((CURDATE() - INTERVAL 8 MONTH), '%Y/%m') AS `month`
        UNION SELECT DATE_FORMAT((CURDATE() - INTERVAL 7 MONTH), '%Y/%m') AS `month`
        UNION SELECT DATE_FORMAT((CURDATE() - INTERVAL 6 MONTH), '%Y/%m') AS `month`
        UNION SELECT DATE_FORMAT((CURDATE() - INTERVAL 5 MONTH), '%Y/%m') AS `month`
        UNION SELECT DATE_FORMAT((CURDATE() - INTERVAL 4 MONTH), '%Y/%m') AS `month`
        UNION SELECT DATE_FORMAT((CURDATE() - INTERVAL 3 MONTH), '%Y/%m') AS `month`
        UNION SELECT DATE_FORMAT((CURDATE() - INTERVAL 2 MONTH), '%Y/%m') AS `month`
        UNION SELECT DATE_FORMAT((CURDATE() - INTERVAL 1 MONTH), '%Y/%m') AS `month`
        UNION SELECT DATE_FORMAT(CURDATE(), '%Y/%m') AS `month`
        ) v
        left join
        (select
        DATE_FORMAT(a.accessed_at,'%Y/%m') as 'month',count(*) as count
        from access as a
        where DATE_FORMAT(a.accessed_at,'%Y/%m') >
        DATE_FORMAT(date_sub(curdate(), interval 12 month),'%Y/%m')
        AND blog_domain_name=#{blogDomainName}
        GROUP BY month
        )b
        on v.month = b.month group by v.month
    </select>
    <select id="countByBlogDomainName" resultType="java.lang.Long">
        SELECT
        COUNT(*)
        FROM access
        WHERE blog_domain_name=#{blogDomainName}
    </select>
    <select id="countByLink" resultType="java.lang.Long">
        SELECT
        COUNT(*)
        FROM access
        WHERE link=#{link}
    </select>
    <insert id="save">
        INSERT INTO access (
        <include refid="insert_columns"/>
        ) VALUES (
        #{link},
        #{blogDomainName},
        #{ip},
        #{from},
        now()
        )
    </insert>
</mapper>